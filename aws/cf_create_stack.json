{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Simple EC2 to run Docker image from Docker Hub",
    "Resources": {
      "FlaskEC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          "InstanceType": "t2.micro",
          "ImageId": "ami-0cf10cdf9fcd62d37",
          "KeyName": "flask-app-keypair",
          "SecurityGroupIds": [
            { "Fn::GetAtt": ["FlaskSecurityGroup", "GroupId"] }
          ],
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "apt-get update -y\n",
                  "apt-get install -y docker.io\n",
                  "systemctl start docker\n",
                  "systemctl enable docker\n",
                  "docker pull tkoppine/demo-app1:python-app-1.0\n",
                  "docker run -d --name flaskapp -p 80:5000 tkoppine/demo-app1:python-app-1.0\n"
                ]
              ]
            }
          }
        }
      },
      "FlaskSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "GroupDescription": "Allow HTTP",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": 80,
              "ToPort": 80,
              "CidrIp": "0.0.0.0/0"
            }
          ]
        }
      }
    }
  }